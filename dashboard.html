<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EcoBadge Dashboard</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Load Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <!-- Google Fonts: Plus Jakarta Sans -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet">

    <style>
        body {
            font-family: 'Plus Jakarta Sans', sans-serif;
        }
        
        /* Main Radial Progress (Eco Score) */
        .radial-progress-main {
            width: 160px;
            height: 160px;
            border-radius: 50%;
            background: 
                radial-gradient(closest-side, #ffffff 75%, transparent 76% 100%),
                conic-gradient(#059669 var(--progress), #e2e8f0 0);
            box-shadow: 0 10px 30px -10px rgba(5, 150, 105, 0.3);
        }

        /* Mini Gauge 1: CO2 (Green) */
        .radial-progress-co2 {
            width: 70px;
            height: 70px;
            border-radius: 50%;
            background: 
                radial-gradient(closest-side, #ffffff 75%, transparent 76% 100%),
                conic-gradient(#059669 var(--progress), #e2e8f0 0); 
        }

        /* Mini Gauge 2: CO (Warning Orange) */
        .radial-progress-co {
            width: 70px;
            height: 70px;
            border-radius: 50%;
            background: 
                radial-gradient(closest-side, #ffffff 75%, transparent 76% 100%),
                conic-gradient(#f97316 var(--progress), #e2e8f0 0); 
        }

        /* Smooth Fade Transitions */
        .fade-enter {
            animation: fadeIn 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Spinner */
        @keyframes spin { to { transform: rotate(360deg); } }
        .spinner {
            border: 3px solid #e2e8f0;
            border-left-color: #059669;
            border-radius: 50%;
            width: 32px;
            height: 32px;
            animation: spin 1s linear infinite;
        }
    </style>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- Global Firebase Instances ---
        let app, db, auth;
        let userId = null;
        
        // Environment variables
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        // --- LLM API Configuration ---
        const API_URL = "https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent";
        const API_KEY = ""; // Handled by Canvas

        // --- Tailwind Configuration ---
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#059669', // Emerald 600 (Darker, richer green)
                        secondary: '#064e3b', // Emerald 900 (Text headings)
                        accent: '#34d399', // Emerald 400 (Highlights)
                        background: '#f8fafc', // Slate 50 (Light gray/white)
                        surface: '#ffffff', // Pure White
                        subtext: '#64748b', // Slate 500
                    },
                    boxShadow: {
                        'soft': '0 4px 20px -2px rgba(0, 0, 0, 0.05)',
                        'glow': '0 0 15px rgba(5, 150, 105, 0.3)',
                    }
                }
            }
        }

        // --- Screen Management ---
        function showScreen(screenId) {
            ['loading', 'login', 'dashboard'].forEach(id => {
                const screen = document.getElementById(`${id}-screen`);
                if (screen) {
                     screen.classList.add('hidden');
                     screen.classList.remove('fade-enter');
                }
            });
            
            const screen = document.getElementById(`${screenId}-screen`);
            if (screen) {
                screen.classList.remove('hidden');
                screen.classList.add('fade-enter');
            }

            if (screenId === 'dashboard') initializeDashboardUI();
        }

        // --- Firebase Logic ---
        async function initializeFirebase() {
            if (Object.keys(firebaseConfig).length === 0) {
                console.error("Firebase config missing.");
                showScreen('login');
                return;
            }

            try {
                app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);

                onAuthStateChanged(auth, (user) => {
                    const statusEl = document.getElementById('user-status-text');
                    const iconEl = document.getElementById('user-status-icon');

                    if (user) {
                        userId = user.uid;
                        if (statusEl) statusEl.textContent = 'Online';
                        if (iconEl) iconEl.classList.add('bg-green-500');
                        document.getElementById('user-id-display').textContent = userId;
                        showScreen('dashboard');
                    } else {
                        if (statusEl) statusEl.textContent = 'Offline';
                        if (iconEl) iconEl.classList.remove('bg-green-500');
                        document.getElementById('user-id-display').textContent = 'Anonymous';
                        showScreen('login');
                    }
                });

                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }
            } catch (error) {
                console.error("Auth failed:", error);
                showScreen('login');
            }
        }

        // --- LLM Logic (Gemini) ---
        async function fetchWithBackoff(url, options, maxRetries = 3) {
            for (let i = 0; i < maxRetries; i++) {
                try {
                    const response = await fetch(url, options);
                    if (!response.ok) {
                        if (response.status === 429 && i < maxRetries - 1) {
                            await new Promise(resolve => setTimeout(resolve, 1000 * Math.pow(2, i)));
                            continue;
                        }
                        throw new Error(`HTTP ${response.status}`);
                    }
                    return await response.json();
                } catch (error) {
                    if (i === maxRetries - 1) throw error;
                    // For network errors, use exponential backoff
                    await new Promise(resolve => setTimeout(resolve, 1000 * Math.pow(2, i)));
                }
            }
        }

        async function generateEcoTip() {
            const output = document.getElementById('llm-tip-output');
            const btn = document.getElementById('generate-tip-btn');
            const btnText = document.getElementById('btn-text');
            const btnIcon = document.getElementById('btn-icon');

            output.classList.add('opacity-50');
            btn.disabled = true;
            btnText.textContent = "Thinking...";
            btnIcon.classList.remove('text-emerald-600', 'fill-current');
            btnIcon.classList.add('animate-spin', 'text-slate-900');

            const systemPrompt = "You are an elite Eco-Driving Consultant. Analyze data and give one sophisticated, high-impact tip to reduce carbon footprint. Tone: Professional, encouraging, concise.";
            const userQuery = "User Stats: Score 85/100. High NOₓ on highway. CO₂ 1.2kg. Goal: Reach 90.";

            const payload = {
                contents: [{ parts: [{ text: userQuery }] }],
                systemInstruction: { parts: [{ text: systemPrompt }] }
            };

            try {
                const url = `${API_URL}?key=${API_KEY}`;
                const result = await fetchWithBackoff(url, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                
                const text = result.candidates?.[0]?.content?.parts?.[0]?.text;
                if (text) {
                    output.textContent = text.trim();
                    output.classList.remove('italic', 'opacity-50');
                } else {
                    output.textContent = "Unable to generate insight. Response was empty.";
                }
            } catch (e) {
                console.error("Gemini API Error:", e);
                output.textContent = "Connection unstable. Please retry.";
            } finally {
                btn.disabled = false;
                btnText.textContent = "Refresh Advice";
                btnIcon.classList.remove('animate-spin', 'text-slate-900');
                btnIcon.classList.add('text-emerald-600', 'fill-current');
            }
        }
        window.generateEcoTip = generateEcoTip;

        // --- Dashboard UI ---
        function setTab(tabName) {
            ['dashboard', 'rewards'].forEach(t => {
                const content = document.getElementById(`${t}-content`);
                const btn = document.getElementById(`${t}-tab`);
                
                if (t === tabName) {
                    content.classList.remove('hidden');
                    content.classList.add('fade-enter');
                    btn.classList.add('text-secondary', 'bg-white', 'shadow-sm');
                    btn.classList.remove('text-subtext', 'hover:bg-slate-100');
                } else {
                    content.classList.add('hidden');
                    content.classList.remove('fade-enter');
                    btn.classList.remove('text-secondary', 'bg-white', 'shadow-sm');
                    btn.classList.add('text-subtext', 'hover:bg-slate-100');
                }
            });
        }

        function initializeDashboardUI() {
            setTab('dashboard');
            
            // Set mock gauge data and animate Eco Score
            const ecoScore = 85;
            const co2Progress = 75;
            const coProgress = 40;

            // Main Eco Score Animation
            const progressBar = document.getElementById('eco-score-progress');
            progressBar.style.setProperty('--progress', `${ecoScore}%`);
            let counter = 0;
            const interval = setInterval(() => {
                if(counter >= ecoScore) {
                    clearInterval(interval);
                    counter = ecoScore;
                }
                document.getElementById('eco-score-text').textContent = counter++;
            }, 10);
            
            // Mini Gauges
            document.getElementById('co2-gauge').style.setProperty('--progress', `${co2Progress}%`);
            document.getElementById('co-gauge').style.setProperty('--progress', `${coProgress}%`);
            
            document.getElementById('co2-gauge-text').textContent = `${co2Progress}%`;
            document.getElementById('co-gauge-text').textContent = `${coProgress}%`;

            // Bar chart - set heights for mock data (Mon-Sun)
            const emissionData = [20, 45, 60, 80, 50, 95, 30]; // Heights in percentage
            const bars = document.querySelectorAll('.emission-bar');
            bars.forEach((bar, index) => {
                bar.style.height = `${emissionData[index]}%`;
            });
            
            // Initial LLM text
            const initialTip = "Tap the button below to analyze your recent highway trip and generate a personalized efficiency strategy.";
            document.getElementById('llm-tip-output').textContent = initialTip;
        }

        window.handleLogin = () => {
            if (auth && !auth.currentUser) {
                signInAnonymously(auth).catch(console.error);
            } else {
                showScreen('dashboard');
            }
        };

        window.onload = () => {
            try {
                lucide.createIcons();
            } catch(e) {
                console.error("Lucide icon loading failed:", e);
            }

            showScreen('login');
            initializeFirebase();
            window.setTab = setTab;
        };
    </script>
</head>
<body class="bg-background text-slate-800 min-h-screen flex justify-center font-sans selection:bg-primary selection:text-white">

    <div class="w-full md:max-w-2xl relative">
        
        <!-- === 1. Loading === -->
        <div id="loading-screen" class="min-h-screen flex flex-col items-center justify-center hidden bg-background z-50">
            <div class="spinner"></div>
        </div>

        <!-- === 2. Login Screen (Refined) === -->
        <div id="login-screen" class="min-h-screen flex flex-col items-center justify-center p-6 hidden">
            <div class="bg-surface w-full max-w-sm p-10 rounded-3xl shadow-soft border border-slate-100 text-center">
                <div class="w-16 h-16 bg-green-50 rounded-2xl flex items-center justify-center mx-auto mb-6 text-primary shadow-inner">
                    <i data-lucide="leaf" class="w-8 h-8 fill-current"></i>
                </div>
                
                <h1 class="text-3xl font-bold text-secondary mb-2 tracking-tight">EcoBadge</h1>
                <p class="text-subtext mb-8 leading-relaxed">Your personal companion for sustainable driving and real-world rewards.</p>
                
                <button onclick="window.handleLogin()" class="group w-full bg-primary hover:bg-emerald-700 text-white font-semibold py-4 rounded-xl shadow-lg shadow-emerald-500/20 transition-all transform hover:scale-[1.02] active:scale-[0.98] flex items-center justify-center">
                    <span>Start Your Journey</span>
                    <i data-lucide="arrow-right" class="w-5 h-5 ml-2 group-hover:translate-x-1 transition-transform"></i>
                </button>

                <p class="text-xs text-slate-400 mt-6">Secured by Google Firebase</p>
            </div>
        </div>

        <!-- === 3. Dashboard (Refined) === -->
        <div id="dashboard-screen" class="hidden min-h-screen flex flex-col p-4 md:p-6">
            
            <!-- Top Bar -->
            <header class="flex justify-between items-center py-4 mb-8">
                <div class="flex items-center space-x-3">
                    <div class="w-10 h-10 bg-primary text-white rounded-xl flex items-center justify-center shadow-lg shadow-emerald-500/20">
                        <i data-lucide="leaf" class="w-6 h-6 fill-current"></i>
                    </div>
                    <div>
                        <h2 class="text-xl font-bold text-secondary leading-none">EcoBadge</h2>
                        <div class="text-xs text-subtext font-medium flex items-center mt-1">
                            <span id="user-status-icon" class="w-2 h-2 rounded-full mr-2 bg-slate-400"></span>
                            <span id="user-status-text">Connecting...</span>
                        </div>
                    </div>
                </div>
                <div class="text-right">
                    <p class="text-xs text-subtext">User ID:</p>
                    <p id="user-id-display" class="text-xs font-semibold text-secondary truncate max-w-[120px]"></p>
                </div>
            </header>

            <!-- Navigation Tabs (Floating Pill) -->
            <div class="bg-slate-100 p-1.5 rounded-2xl flex mb-8 mx-auto w-full max-w-sm">
                <button id="dashboard-tab" onclick="setTab('dashboard')" class="flex-1 py-2.5 rounded-xl text-sm font-bold text-secondary bg-white shadow-sm transition-all">
                    Overview
                </button>
                <button id="rewards-tab" onclick="setTab('rewards')" class="flex-1 py-2.5 rounded-xl text-sm font-medium text-subtext hover:bg-white/50 transition-all">
                    Rewards
                </button>
            </div>

            <!-- CONTENT: Dashboard -->
            <main id="dashboard-content" class="flex-1">
                
                <!-- Score Card & Mini Gauges -->
                <div class="bg-surface rounded-3xl p-6 shadow-soft border border-slate-50 mb-6 flex flex-col items-center text-center relative overflow-hidden">
                    <div class="absolute top-0 left-0 w-full h-2 bg-gradient-to-r from-primary to-teal-400"></div>
                    
                    <h3 class="text-sm font-bold text-subtext uppercase tracking-wider mb-6 mt-2">Overall Eco Score</h3>
                    
                    <!-- Main Score and Mini Gauges -->
                    <div class="flex flex-wrap items-center justify-around w-full max-w-sm">
                        
                        <!-- Mini Gauge 1: CO2 -->
                        <div class="flex flex-col items-center m-2">
                            <h4 class="text-xs font-medium text-subtext mb-2 text-primary">CO₂ Output</h4>
                            <div id="co2-gauge" class="radial-progress-co2 flex items-center justify-center relative" style="--progress: 0;">
                                <span id="co2-gauge-text" class="text-sm font-bold text-secondary absolute">--%</span>
                            </div>
                        </div>

                        <!-- Main Eco Score -->
                        <div id="eco-score-progress" class="radial-progress-main flex items-center justify-center relative shadow-glow m-4" style="--progress: 0;">
                            <div class="flex flex-col items-center z-10">
                                <span id="eco-score-text" class="text-5xl font-extrabold text-secondary tracking-tighter">0</span>
                                <span class="text-xs text-subtext font-semibold mt-1">SCORE</span>
                            </div>
                        </div>

                        <!-- Mini Gauge 2: CO -->
                        <div class="flex flex-col items-center m-2">
                            <h4 class="text-xs font-medium text-subtext mb-2 text-orange-500">CO Output</h4>
                            <div id="co-gauge" class="radial-progress-co flex items-center justify-center relative" style="--progress: 0;">
                                <span id="co-gauge-text" class="text-sm font-bold text-secondary absolute">--%</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="flex items-center px-4 py-2 bg-green-50 text-emerald-700 rounded-full text-sm font-semibold mt-6">
                        <i data-lucide="trending-up" class="w-4 h-4 mr-2"></i>
                        Top 15% of Drivers
                    </div>
                </div>

                <!-- Emissions Graph -->
                <div class="bg-surface p-5 rounded-3xl shadow-soft border border-slate-50 mb-6">
                    <h3 class="text-lg font-bold text-secondary mb-4">Weekly Emissions Trend (NOₓ)</h3>
                    <div class="h-40 flex items-end justify-between space-x-2 p-2 bg-slate-50 rounded-xl">
                        <!-- Simulated Bar Chart (Max height 100%) -->
                        <div class="w-1/7 relative">
                            <div class="emission-bar w-full bg-primary rounded-t-lg transition-all duration-500 ease-out" style="height: 20%;" title="Mon"></div>
                            <span class="text-[10px] text-subtext absolute -bottom-4 w-full text-center">M</span>
                        </div>
                        <div class="w-1/7 relative">
                            <div class="emission-bar w-full bg-primary rounded-t-lg transition-all duration-500 ease-out" style="height: 45%;" title="Tue"></div>
                            <span class="text-[10px] text-subtext absolute -bottom-4 w-full text-center">T</span>
                        </div>
                        <div class="w-1/7 relative">
                            <div class="emission-bar w-full bg-primary rounded-t-lg transition-all duration-500 ease-out" style="height: 60%;" title="Wed"></div>
                            <span class="text-[10px] text-subtext absolute -bottom-4 w-full text-center">W</span>
                        </div>
                        <div class="w-1/7 relative">
                            <div class="emission-bar w-full bg-orange-400 rounded-t-lg transition-all duration-500 ease-out" style="height: 80%;" title="Thu (High)"></div>
                            <span class="text-[10px] text-subtext absolute -bottom-4 w-full text-center">T</span>
                        </div>
                        <div class="w-1/7 relative">
                            <div class="emission-bar w-full bg-primary rounded-t-lg transition-all duration-500 ease-out" style="height: 50%;" title="Fri"></div>
                            <span class="text-[10px] text-subtext absolute -bottom-4 w-full text-center">F</span>
                        </div>
                        <div class="w-1/7 relative">
                            <div class="emission-bar w-full bg-primary rounded-t-lg transition-all duration-500 ease-out" style="height: 95%;" title="Sat"></div>
                            <span class="text-[10px] text-subtext absolute -bottom-4 w-full text-center">S</span>
                        </div>
                        <div class="w-1/7 relative">
                            <div class="emission-bar w-full bg-primary rounded-t-lg transition-all duration-500 ease-out" style="height: 30%;" title="Sun"></div>
                            <span class="text-[10px] text-subtext absolute -bottom-4 w-full text-center">S</span>
                        </div>
                    </div>
                </div>


                <!-- AI Advisor Card -->
                <div class="bg-gradient-to-br from-slate-800 to-slate-900 rounded-3xl p-6 shadow-xl text-white mb-6 relative overflow-hidden">
                    <i data-lucide="sparkles" class="absolute top-4 right-4 text-white/10 w-24 h-24 -rotate-12"></i>
                    
                    <div class="relative z-10">
                        <div class="flex items-center mb-4">
                            <div class="p-2 bg-white/10 backdrop-blur-md rounded-lg mr-3">
                                <i data-lucide="bot" class="w-5 h-5 text-emerald-400"></i>
                            </div>
                            <h3 class="font-bold text-lg">Eco Advisor</h3>
                        </div>
                        
                        <p id="llm-tip-output" class="text-slate-300 text-sm leading-relaxed mb-6 min-h-[60px]">
                            Tap the button below to analyze your recent highway trip and generate a personalized efficiency strategy.
                        </p>

                        <button id="generate-tip-btn" onclick="window.generateEcoTip()" class="w-full bg-white text-slate-900 font-bold py-3 rounded-xl hover:bg-emerald-50 transition flex items-center justify-center">
                            <i id="btn-icon" data-lucide="zap" class="w-4 h-4 mr-2 fill-current text-emerald-600"></i>
                            <span id="btn-text">Generate Insight</span>
                        </button>
                    </div>
                </div>
            </main>

            <!-- CONTENT: Rewards -->
            <main id="rewards-content" class="hidden flex-1">
                <!-- Balance Card -->
                <div class="bg-primary rounded-3xl p-8 shadow-lg shadow-emerald-500/30 text-white mb-8 relative overflow-hidden">
                    <div class="absolute -right-10 -top-10 w-40 h-40 bg-white/10 rounded-full blur-2xl"></div>
                    
                    <p class="text-emerald-100 font-medium mb-1">Total Balance</p>
                    <div class="flex items-baseline">
                        <h2 class="text-5xl font-bold tracking-tight mr-2">1,540</h2>
                        <span class="text-lg font-medium text-emerald-200">PTS</span>
                    </div>
                    <div class="mt-6 flex gap-3">
                        <button class="flex-1 bg-white text-emerald-800 font-bold py-2.5 rounded-xl text-sm hover:bg-emerald-50 transition">
                            Redeem
                        </button>
                        <button class="flex-1 bg-emerald-700 text-white font-bold py-2.5 rounded-xl text-sm hover:bg-emerald-800 transition">
                            History
                        </button>
                    </div>
                </div>

                <!-- Badges List -->
                <h3 class="text-lg font-bold text-secondary mb-4 px-2">Achievements</h3>
                <div class="space-y-3">
                    <!-- Item -->
                    <div class="bg-surface p-4 rounded-2xl border border-slate-100 shadow-sm flex items-center">
                        <div class="w-12 h-12 rounded-full bg-amber-100 flex items-center justify-center text-amber-600 mr-4">
                            <i data-lucide="award" class="w-6 h-6 fill-current"></i>
                        </div>
                        <div class="flex-1">
                            <h4 class="font-bold text-secondary">Bronze Commuter</h4>
                            <p class="text-xs text-subtext">Maintained 80+ score for 1 week</p>
                        </div>
                        <i data-lucide="check-circle-2" class="w-5 h-5 text-primary fill-green-50"></i>
                    </div>

                    <!-- Item -->
                    <div class="bg-surface p-4 rounded-2xl border border-slate-100 shadow-sm flex items-center">
                        <div class="w-12 h-12 rounded-full bg-emerald-100 flex items-center justify-center text-emerald-600 mr-4">
                            <i data-lucide="sprout" class="w-6 h-6 fill-current"></i>
                        </div>
                        <div class="flex-1">
                            <h4 class="font-bold text-secondary">Green Driver</h4>
                            <p class="text-xs text-subtext">Saved 10kg of CO₂ total</p>
                        </div>
                        <i data-lucide="check-circle-2" class="w-5 h-5 text-primary fill-green-50"></i>
                    </div>

                    <!-- Item Locked -->
                    <div class="bg-slate-50 p-4 rounded-2xl border border-slate-100 flex items-center opacity-60">
                        <div class="w-12 h-12 rounded-full bg-slate-200 flex items-center justify-center text-slate-400 mr-4">
                            <i data-lucide="crown" class="w-6 h-6"></i>
                        </div>
                        <div class="flex-1">
                            <h4 class="font-bold text-slate-500">Eco King</h4>
                            <p class="text-xs text-slate-400">Reach 5,000 PTS</p>
                        </div>
                        <i data-lucide="lock" class="w-4 h-4 text-slate-400"></i>
                    </div>
                </div>
            </main>
        </div>
    </div>
</body>
</html>rs